var MvcGrid=function(){function l(e,t){var r=this;if(t=t||{},(e=r.findGrid(e)).dataset.id)return r.instances[parseInt(e.dataset.id)].set(t);r.columns=[],r.element=e,r.loadingDelay=300,r.requestType="get",r.name=e.dataset.name,r.popup=new MvcGridPopup(r),r.filterMode=e.dataset.filterMode,r.prefix=r.name?r.name+"-":"",r.sourceUrl=r.element.dataset.sourceUrl,r.element.dataset.id=t.id||r.instances.length,r.filters={enum:MvcGridEnumFilter,date:MvcGridDateFilter,guid:MvcGridGuidFilter,text:MvcGridTextFilter,number:MvcGridNumberFilter,boolean:MvcGridBooleanFilter};var i=e.querySelectorAll(".mvc-grid-row-filters th");[].forEach.call(e.querySelectorAll(".mvc-grid-headers th"),function(e,t){r.columns.push(new MvcGridColumn(r,e,i[t]))});var n=e.querySelector(".mvc-grid-pager");n&&(r.pager=new MvcGridPager(r,n)),t.id?r.instances[parseInt(t.id)]=r:r.instances.push(r),r.set(t),r.cleanUp(),r.bind(),r.sourceUrl&&!e.children.length&&r.reload()}return l.prototype={instances:[],lang:{text:{contains:"Contains",equals:"Equals","not-equals":"Not equals","starts-with":"Starts with","ends-with":"Ends with"},number:{equals:"Equals","not-equals":"Not equals","less-than":"Less than","greater-than":"Greater than","less-than-or-equal":"Less than or equal","greater-than-or-equal":"Greater than or equal"},date:{equals:"Equals","not-equals":"Not equals","earlier-than":"Earlier than","later-than":"Later than","earlier-than-or-equal":"Earlier than or equal","later-than-or-equal":"Later than or equal"},enum:{equals:"Equals","not-equals":"Not equals"},guid:{equals:"Equals","not-equals":"Not equals"},boolean:{equals:"Equals","not-equals":"Not equals"},filter:{apply:"&#10004;",remove:"&#10008;"},operator:{select:"",and:"and",or:"or"}},findGrid:function(e){var t=e;if(!t)throw new Error("Grid element was not specified.");for(;t&&!t.classList.contains("mvc-grid");)t=t.parentElement;if(!t)throw new Error("Grid can only be created from within mvc-grid structure.");return t},set:function(e){var t=this,r=e.filters||{};for(var i in r)t.filters[i]=r[i];if(t.columns.forEach(function(e){e.filter&&t.filters[e.filter.name]&&(e.filter.instance=new t.filters[e.filter.name](e),e.filter.instance.init())}),t.requestType=e.requestType||t.requestType,t.sourceUrl=void 0===e.sourceUrl?t.sourceUrl:e.sourceUrl,t.loadingDelay=void 0===e.loadingDelay?t.loadingDelay:e.loadingDelay,t.sourceUrl){var n=t.sourceUrl.split("?",2);t.sourceUrl=n[0],void 0!==e.query?t.query=new MvcGridQuery(e.query):!n[1]&&t.query||(t.query=new MvcGridQuery(n[1]))}else void 0!==e.query?t.query=new MvcGridQuery(e.query):t.query=new MvcGridQuery(window.location.search);return this},reload:function(){var n=this;n.dispatchEvent("reloadstart",{grid:n}),n.sourceUrl?n.startLoading(function(e){for(var t=-1,r=n.element.parentElement;r.children[++t]!=n.element;);if(n.element.outerHTML=e,!r.children[t].classList.contains("mvc-grid"))throw new Error("Grid partial should only include grid declaration.");var i=new l(r.children[t],{loadingDelay:n.loadingDelay,requestType:n.requestType,query:n.query.toString(),id:n.element.dataset.id,sourceUrl:n.sourceUrl,filters:n.filters});i.dispatchEvent("reloadend",{grid:i})},function(e){n.dispatchEvent("reloadfail",{grid:n,result:e})}):window.location.href=window.location.origin+window.location.pathname+n.query},startLoading:function(e,t){var r=this,i=(r.query.toString()?r.query+"&":"?")+"_="+Date.now();if(r.stopLoading(),null!=r.loadingDelay&&!r.element.querySelector(".mvc-grid-loader")){var n=document.createElement("div");n.appendChild(document.createElement("div")),n.appendChild(document.createElement("div")),n.appendChild(document.createElement("div")),r.loader=document.createElement("div"),r.loader.className="mvc-grid-loader",r.loader.appendChild(n),r.loading=setTimeout(function(){r.loader.classList.add("mvc-grid-loading")},r.loadingDelay),r.element.appendChild(r.loader)}r.request=new XMLHttpRequest,r.request.open(r.requestType,r.sourceUrl+i,!0),r.request.setRequestHeader("X-Requested-With","XMLHttpRequest"),r.request.onload=function(){200<=r.request.status&&r.request.status<400?e(r.request.responseText):t&&t(r.request.responseText)},r.request.onerror=t,r.request.send()},stopLoading:function(){var e=this;e.request&&4!=e.request.readyState&&e.request.abort(),clearTimeout(e.loading),e.loader&&e.loader.parentElement.removeChild(e.loader)},dispatchEvent:function(e,t){var r;"function"==typeof Event?r=new CustomEvent(e,{detail:t,bubbles:!0}):((r=document.createEvent("Event")).initEvent(e,!0,!0),r.detail=t),this.element.dispatchEvent(r)},bind:function(){var l=this;[].forEach.call(l.element.querySelectorAll("tbody tr"),function(n){n.classList.contains("mvc-grid-empty-row")||n.addEventListener("click",function(e){var t,r={};l.columns.forEach(function(e,t){r[e.name]=n.cells[t].innerText});var i={grid:l,data:r,originalEvent:e};"function"==typeof Event?t=new CustomEvent("rowclick",{detail:i,bubbles:!0}):((t=document.createEvent("Event")).initEvent("rowclick",!0,!0),t.detail=i),this.dispatchEvent(t)})})},cleanUp:function(){delete this.element.dataset.sourceUrl,delete this.element.dataset.filterMode}},l}(),MvcGridColumn=function(){function e(e,t,r){var i=this,n=t.dataset;if(i.grid=e,i.header=t,i.name=n.name,i.rowFilter=r,"True"==n.filter){var l=t.querySelector(".mvc-grid-options");l?l.parentElement.removeChild(l):"FilterRow"==e.filterMode&&(l=r.querySelector("select.mvc-grid-value")),i.filter={isApplied:""!=n.filterFirstMethod||""!=n.filterSecondMethod,hasOptions:l&&0<l.children.length,defaultMethod:n.filterDefaultMethod,isMulti:"True"==n.filterMulti,operator:n.filterOperator,name:n.filterName,options:l,first:{method:n.filterFirstMethod,value:n.filterFirstValue},second:{method:n.filterSecondMethod,value:n.filterSecondValue}}}"True"==n.sort&&"HeaderRow"!=e.filterMode&&(i.sort={first:n.sortFirst,order:n.sortOrder}),i.bindFilter(),i.bindSort(),i.cleanUp()}return e.prototype={cancelFilter:function(){if(this.filter.isApplied){var e=this.grid;e.query.delete(e.prefix+"page"),e.query.delete(e.prefix+"rows"),e.query.deleteStartingWith(e.prefix+this.name+"-"),e.reload()}else this.filter.first.value="",this.filter.second.value=""},applyFilter:function(){var e=this,t=e.grid,r=e.filter;t.query.delete(t.prefix+"page"),t.query.delete(t.prefix+"rows"),t.query.deleteStartingWith(t.prefix+e.name+"-"),t.query.append(t.prefix+e.name+"-"+r.first.method,r.first.value),"ExcelRow"==t.filterMode&&r.isMulti&&(t.query.append(t.prefix+e.name+"-op",r.operator),t.query.append(t.prefix+e.name+"-"+r.second.method,r.second.value)),t.pager&&t.pager.showPageSizes&&t.query.append(t.prefix+"rows",t.pager.rowsPerPage.value),t.reload()},applySort:function(){var e=this,t=this.grid;t.query.delete(t.prefix+"sort"),t.query.delete(t.prefix+"order");var r="asc"==e.sort.order?"desc":"asc";!e.sort.order&&e.sort.first&&(r=e.sort.first),t.query.append(t.prefix+"sort",e.name),t.query.append(t.prefix+"order",r),t.reload()},bindFilter:function(){var t=this;if(t.filter)if((t.rowFilter||t.header).querySelector(".mvc-grid-filter").addEventListener("click",function(){t.filter.instance.show()}),t.filter.hasOptions){if("FilterRow"==t.grid.filterMode)t.rowFilter.querySelector("select").addEventListener("change",function(){t.filter.first.value=this.value,t.filter.instance.apply()});else if("HeaderRow"==t.grid.filterMode){var e=t.rowFilter.querySelector(".mvc-grid-value");e.readOnly=!0,e.tabIndex=-1}}else if("ExcelRow"!=t.grid.filterMode){var r=t.rowFilter.querySelector(".mvc-grid-value");r.addEventListener("input",function(){t.filter.first.value=this.value,t.filter.instance.validate(this)}),r.addEventListener("keyup",function(e){13==e.which&&t.filter.instance.isValid(this.value)&&t.filter.instance.apply()})}},bindSort:function(){var t=this;t.sort&&t.header.addEventListener("click",function(e){e.target.classList.contains("mvc-grid-filter")||t.applySort()})},cleanUp:function(){var e=this.header.dataset;delete e.filterDefaultMethod,delete e.filterSecondMethod,delete e.filterSecondValue,delete e.filterFirstMethod,delete e.filterFirstValue,delete e.filterOperator,delete e.filterMulti,delete e.filterName,delete e.filter,delete e.sortOrder,delete e.sortFirst,delete e.sort,delete e.name}},e}(),MvcGridPager=function(){function e(e,t){var r=this;r.grid=e,r.element=t,r.pages=t.querySelectorAll("[data-page]"),r.showPageSizes="True"==t.dataset.showPageSizes,r.rowsPerPage=t.querySelector(".mvc-grid-pager-rows"),r.currentPage=r.pages.length?parseInt(t.querySelector(".active").dataset.page):1,r.cleanUp(),r.bind()}return e.prototype={apply:function(e){var t=this.grid;t.query.delete(t.prefix+"page"),t.query.delete(t.prefix+"rows"),t.query.append(t.prefix+"page",e),this.showPageSizes&&t.query.append(t.prefix+"rows",this.rowsPerPage.value),t.reload()},bind:function(){var t=this;[].forEach.call(t.pages,function(e){e.addEventListener("click",function(){t.apply(this.dataset.page)})}),t.rowsPerPage.addEventListener("change",function(){t.apply(t.currentPage)})},cleanUp:function(){delete this.element.dataset.showPageSizes}},e}(),MvcGridPopup=function(){function i(e){this.element.className="mvc-grid-popup",this.grid=e,this.bind()}return i.prototype={lastActiveElement:null,element:document.createElement("div"),render:function(e){this.element.className=("mvc-grid-popup "+e.cssClasses).trim(),this.element.innerHTML=e.render(),this.updateValues(e.column)},updatePosition:function(e){var t=(e.rowFilter||e.header).querySelector(".mvc-grid-filter"),r=this.element.querySelector(".popup-arrow"),i=t.getBoundingClientRect(),n=this.element.clientWidth,l=window.pageYOffset+i.top+.6*t.offsetHeight+r.offsetHeight,a=window.pageXOffset+i.left-8,o=t.offsetWidth/2;if(a+n+8>window.pageXOffset+document.documentElement.clientWidth){var s=n-t.offsetWidth-16;o+=s,a-=s}this.element.style.left=a+"px",this.element.style.top=l+"px",r.style.left=o+"px"},updateValues:function(e){var t=e.filter;this.updateValue(".mvc-grid-operator",t.operator),this.updateValue('.mvc-grid-value[data-filter="first"]',t.first.value),this.updateValue('.mvc-grid-value[data-filter="second"]',t.second.value),this.updateValue('.mvc-grid-method[data-filter="first"]',t.first.method),this.updateValue('.mvc-grid-method[data-filter="second"]',t.second.method)},updateValue:function(e,t){var r=this.element.querySelector(e);r&&(r.value=t)},show:function(e){i.prototype.lastActiveElement=document.activeElement,this.element.parentElement||document.body.appendChild(this.element),this.updatePosition(e),this.element.querySelector("input,select,textarea").focus()},hide:function(e){for(var t=e&&e.target;t&&!/mvc-grid-(popup|filter)/.test(t.className);)t=t.parentElement;var r=i.prototype;t&&27!=e.which||!r.element.parentNode||(document.body.removeChild(r.element),r.lastActiveElement&&(r.lastActiveElement.focus(),r.lastActiveElement=null))},bind:function(){window.addEventListener("click",this.hide),window.addEventListener("resize",this.hide),window.addEventListener("keydown",this.hide)}},i}(),MvcGridQuery=function(){function e(e){this.query=(e||"").replace("?","")}return e.prototype={set:function(e,t){this.delete(e),this.append(e,t)},append:function(e,t){this.query+=this.query?"&":"",this.query+=encodeURIComponent(e)+"="+encodeURIComponent(t||"")},delete:function(t){t=encodeURIComponent(t),this.query=this.query.split("&").filter(function(e){return e.split("=",1)[0]!=t}).join("&")},deleteStartingWith:function(t){t=encodeURIComponent(t),this.query=this.query.split("&").filter(function(e){return e.split("=",1)[0].indexOf(t)}).join("&")},toString:function(){return this.query?"?"+this.query:""}},e}();function MvcGridExtends(e,t){function r(){this.constructor=e}Object.setPrototypeOf(e,t),e.prototype=(r.prototype=t.prototype,new r)}var MvcGridFilter=function(){function e(e){this.isMulti=e.filter.isMulti,this.mode=e.grid.filterMode,this.popup=e.grid.popup,this.cssClasses="",this.column=e,this.methods=[]}return e.prototype={init:function(){var e=this,t=e.column;t.filter.hasOptions||"ExcelRow"==e.mode||e.validate(t.rowFilter.querySelector(".mvc-grid-value")),e.methods.indexOf(t.filter.first.method)<0&&(t.filter.first.method=t.filter.defaultMethod||e.methods[0]),e.methods.indexOf(t.filter.second.method)<0&&(t.filter.second.method=t.filter.defaultMethod||e.methods[0])},show:function(){var e=this;e.popup.render(e),e.bindOperator(),e.bindMethods(),e.bindValues(),e.bindActions(),e.popup.show(e.column)},render:function(){return this.lang=this.column.grid.lang,'<div class="popup-arrow"></div><div class="popup-content"><div class="popup-filter">'+this.renderFilter("first")+"</div>"+("ExcelRow"==this.mode&&this.isMulti?this.renderOperator()+'<div class="popup-filter">'+this.renderFilter("second")+"</div>":"")+this.renderActions()+"</div>"},renderFilter:function(e){var t=this.column.filter.hasOptions,r=this.lang[this.column.filter.name]||{};return'<div class="popup-group"><select class="mvc-grid-method" data-filter="'+e+'">'+this.methods.map(function(e){return'<option value="'+e+'">'+(r[e]||"")+"</option>"}).join("")+'</select></div><div class="popup-group">'+(t?'<select class="mvc-grid-value" data-filter="'+e+'">'+this.column.filter.options.innerHTML+"</select>":'<input class="mvc-grid-value" data-filter="'+e+'">')+"</div>"},renderOperator:function(){return'<div class="popup-operator"><div class="popup-group"><select class="mvc-grid-operator"><option value="">'+this.lang.operator.select+'</option><option value="and">'+this.lang.operator.and+'</option><option value="or">'+this.lang.operator.or+"</option></select></div></div>"},renderActions:function(){return'<div class="popup-actions"><button type="button" class="mvc-grid-apply" type="button">'+this.lang.filter.apply+'</button><button type="button" class="mvc-grid-cancel" type="button">'+this.lang.filter.remove+"</button></div>"},apply:function(){MvcGridPopup.prototype.lastActiveElement=null,this.column.applyFilter(),this.popup.hide()},cancel:function(){this.column.filter.isApplied&&(MvcGridPopup.prototype.lastActiveElement=null),this.column.cancelFilter(),this.popup.hide()},isValid:function(){return!0},validate:function(e){this.isValid(e.value)?e.classList.remove("invalid"):e.classList.add("invalid")},bindOperator:function(){var e=this.column.filter,t=this.popup.element.querySelector(".mvc-grid-operator");t&&t.addEventListener("change",function(){e.operator=this.value})},bindMethods:function(){var t=this.column.filter;[].forEach.call(this.popup.element.querySelectorAll(".mvc-grid-method"),function(e){e.addEventListener("change",function(){t[this.dataset.filter].method=this.value})})},bindValues:function(){var t=this;[].forEach.call(t.popup.element.querySelectorAll(".mvc-grid-value"),function(e){e.addEventListener("input",function(){if(t.column.filter[this.dataset.filter].value=this.value,"ExcelRow"!=t.mode){var e=t.column.rowFilter.querySelector(".mvc-grid-value");"SELECT"==this.tagName?e.value=this.options[this.selectedIndex].text:e.value=this.value,t.validate(e)}t.validate(this)}),e.addEventListener("keyup",function(e){13==e.which&&t.isValid(this.value)&&t.apply()}),t.validate(e)})},bindActions:function(){var e=this.popup.element;e.querySelector(".mvc-grid-apply").addEventListener("click",this.apply.bind(this)),e.querySelector(".mvc-grid-cancel").addEventListener("click",this.cancel.bind(this))}},e}(),MvcGridTextFilter=function(t){function e(e){t.call(this,e),this.methods=["contains","equals","not-equals","starts-with","ends-with"]}return MvcGridExtends(e,t),e}(MvcGridFilter),MvcGridNumberFilter=function(t){function e(e){t.call(this,e),this.methods=["equals","not-equals","less-than","greater-than","less-than-or-equal","greater-than-or-equal"]}return MvcGridExtends(e,t),e.prototype.isValid=function(e){return!e||/^(?=.*\d+.*)[-+]?\d*[.,]?\d*$/.test(e)},e}(MvcGridFilter),MvcGridDateFilter=function(t){function e(e){t.call(this,e),this.methods=["equals","not-equals","earlier-than","later-than","earlier-than-or-equal","later-than-or-equal"]}return MvcGridExtends(e,t),e}(MvcGridFilter),MvcGridEnumFilter=function(t){function e(e){t.call(this,e),this.methods=["equals","not-equals"]}return MvcGridExtends(e,t),e}(MvcGridFilter),MvcGridGuidFilter=function(t){function e(e){t.call(this,e),this.methods=["equals","not-equals"],this.cssClasses="mvc-grid-guid-filter"}return MvcGridExtends(e,t),e.prototype.isValid=function(e){return!e||/^[0-9A-F]{8}[-]?([0-9A-F]{4}[-]?){3}[0-9A-F]{12}$/i.test(e)},e}(MvcGridFilter),MvcGridBooleanFilter=function(t){function e(e){t.call(this,e),this.methods=["equals","not-equals"]}return MvcGridExtends(e,t),e}(MvcGridFilter);
